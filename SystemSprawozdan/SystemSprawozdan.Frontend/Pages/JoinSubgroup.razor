@page "/join-subgroup/{groupId}"

@inject IAppHttpClient AppHttpClient
@inject IMatToaster Toaster
@inject NavigationManager NavigationManager

<PageTitle>Dołącz do grupy</PageTitle>

<style>
    .edit-field{
        display:flex;
        justify-content:center;
        align-items:center;
        width: 100%;
    }

</style>

<div class="block">
    <div class="block-left">
        <h4>Dane zespołu: </h4>
        <p><b>Przedmiot:</b> @groupSubjectName</p>
        <p><b>Rodzaj:</b> @groupType</p>
        <p><b>Grupa:</b> @groupName</p>
        <p><b>Prowadzący:</b> @groupTeacher</p>
    </div>
    <div class="block-right">
            <p>Wybierz sposób w jaki chcesz się zapisać do zespołu:</p>
        <p>   
            <MatRadioGroup @bind-Value="@subgroupType" TValue="string" Style="align-self:center;">
                <MatRadioButton Value="@("individual")" Label="Indywidualnie" TValue="string"></MatRadioButton>
                <MatRadioButton Value="@("group")" Label="Grupowo" TValue="string"></MatRadioButton>
            </MatRadioGroup>
        </p>

        
        <div id="@subgroupType">
            <p>Wybierz grupę roboczą: </p>
            <p>
                <MatSelectItem Outlined="true" Label="Grupa" class="edit-field" @bind-Value="subgroupSelect" Items="@subgroupSelectItems"></MatSelectItem>
            </p>
            <br />
            <p>Jeżeli twojej grupy nie ma na liście wpisz ją poniżej:</p>
            <p>
                <MatTextField Outlined="true" class="edit-field" @bind-Value="@subgroupName" Label="Nazwa grupy"></MatTextField>
                <ValidationMessage For="@(() => subgroupName)" style="font-size:12px;" />
            </p>

        </div>
        <div class="block-button">
        <MatButton OnClick="joinSubgroup" Style="height: 80px; width:120%; font-size: var(--font-size-large);" Raised="true">Zapisz się na zajęcia</MatButton>
        </div>
    </div>
</div>


@code {
    protected override async Task OnInitializedAsync()
    {
        subgroupSelectItems.Add("");
        int intGroupId = Int32.Parse(groupId);
        var groups = await AppHttpClient.Get<List<SubjectSubgroupGetDto>>("SubjectSubgroup/" + intGroupId + "/GetSubgroups");
        foreach (var group in groups)
        {
            subgroupSelectItems.Add(group.Name);
        }
        var groupDetails = await AppHttpClient.Get<SubjectGroupGetDetailsDto>("SubjectGroup/" + intGroupId + "/GetSubjectGroupDetails");
        groupSubjectName = groupDetails.SubjectName;
        groupType = groupDetails.GroupType;
        groupName = groupDetails.Name;
        groupTeacher = groupDetails.TeacherName;

    }
    public async void joinSubgroup()
    {
        int intGroupId = Int32.Parse(groupId);
        if(subgroupType == "individual")
        {
            var subgroup = new SubjectSubgroupPostDto
                {
                    SubjectGroupId = intGroupId,
                    isIndividual = true,
                    SubgroupName = null
                };
            await AppHttpClient.Post("SubjectSubgroup", subgroup);
            Toaster.Add("Poprawnie stworzono grupę", MatToastType.Success, "Sukces");
            NavigationManager.NavigateTo("/teams");
        }
        else
        {
            if((subgroupName == null || subgroupName == "") && (subgroupSelect == "" || subgroupSelect == null))
            {
                Toaster.Add("Podaj nazwe grupy", MatToastType.Danger, "Błąd");
                return;
            }
            else if(subgroupSelect == "" || subgroupSelect == null)
            {
                var subgroup = new SubjectSubgroupPostDto
                    {
                        SubjectGroupId = intGroupId,
                        isIndividual = false, 
                        SubgroupName = subgroupName
                    };
                await AppHttpClient.Post("SubjectSubgroup", subgroup);
                Toaster.Add("Poprawnie stworzono grupę", MatToastType.Success, "Sukces");
                NavigationManager.NavigateTo("/teams");
            }
            else
            {
                var groups = await AppHttpClient.Get<List<SubjectSubgroupGetDto>>("SubjectSubgroup/" + intGroupId + "/GetSubgroups");
                var subgroup = groups.FirstOrDefault(group => group.Name == subgroupSelect);
                int subgroupId = subgroup.Id;

                await AppHttpClient.Post("SubjectSubgroup/AddUserToSubgroup", subgroupId);
                Toaster.Add("Poprawnie dołączono do grupy", MatToastType.Success, "Sukces");
                NavigationManager.NavigateTo("/teams");
            }
        }
    }
    [Parameter]
    public string groupId { get; set; }
    string groupSubjectName,
           groupType,
           groupName,
           groupTeacher;
    string subgroupType = "individual";
    string? subgroupName;
    string subgroupSelect = "";
    public List<string> subgroupSelectItems = new List<string>();
}
